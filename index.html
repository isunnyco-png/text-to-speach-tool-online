<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Text-to-Speech Translator with Audio Export</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #b8b8d1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4cc9f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h2 i {
            font-size: 1.3rem;
        }

        .input-section textarea {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            padding: 15px;
            font-size: 1.1rem;
            resize: vertical;
            margin-bottom: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: #b8b8d1;
        }

        select, input[type="range"] {
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .voice-gender {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .gender-btn {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .gender-btn.active {
            background: linear-gradient(90deg, #4361ee, #4cc9f0);
            border-color: #4cc9f0;
        }

        .gender-btn:hover {
            background: rgba(67, 97, 238, 0.3);
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #4361ee, #4cc9f0);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-success {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
            min-width: auto;
        }

        .audio-visualizer {
            margin-top: 30px;
        }

        #waveCanvas {
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
        }

        .audio-info {
            font-size: 0.9rem;
            color: #b8b8d1;
        }

        .audio-analysis {
            margin-top: 30px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .analysis-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .analysis-item .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4cc9f0;
            margin-bottom: 5px;
        }

        .analysis-item .label {
            font-size: 0.9rem;
            color: #b8b8d1;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-text {
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-info {
            font-size: 0.8rem;
            color: #b8b8d1;
        }

        .history-actions {
            display: flex;
            gap: 8px;
        }

        .audio-library {
            margin-top: 30px;
        }

        .audio-files {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .audio-file {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .audio-file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .audio-file-title {
            font-weight: 600;
            color: #4cc9f0;
        }

        .audio-file-info {
            font-size: 0.8rem;
            color: #b8b8d1;
        }

        .audio-file-actions {
            display: flex;
            gap: 8px;
        }

        .download-progress {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            display: none;
        }

        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            width: 0%;
            transition: width 0.3s;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #b8b8d1;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .history-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .history-text {
                max-width: 100%;
            }
            
            .audio-files {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-language"></i> Advanced TTS with Audio Export</h1>
            <p class="subtitle">Convert text to speech, export as MP3, and analyze audio in multiple languages</p>
        </header>

        <div class="main-content">
            <div class="input-section panel">
                <h2><i class="fas fa-keyboard"></i> Text Input & Translation</h2>
                <textarea id="textInput" placeholder="Enter text to convert to speech...">Hello! Welcome to our advanced text-to-speech tool. This demo supports multiple languages, male and female voices, MP3 export, and includes real-time audio analysis.</textarea>
                
                <div class="controls">
                    <div class="control-group">
                        <label for="sourceLang"><i class="fas fa-globe"></i> Source Language</label>
                        <select id="sourceLang">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="it">Italian</option>
                            <option value="ja">Japanese</option>
                            <option value="ko">Korean</option>
                            <option value="zh">Chinese</option>
                            <option value="ar">Arabic</option>
                            <option value="ru">Russian</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="targetLang"><i class="fas fa-exchange-alt"></i> Target Language (Translation)</label>
                        <select id="targetLang">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="it">Italian</option>
                            <option value="ja">Japanese</option>
                            <option value="ko">Korean</option>
                            <option value="zh">Chinese</option>
                            <option value="ar">Arabic</option>
                            <option value="ru">Russian</option>
                        </select>
                    </div>
                </div>
                
                <div class="control-group">
                    <label><i class="fas fa-user"></i> Voice Gender</label>
                    <div class="voice-gender">
                        <button id="maleBtn" class="gender-btn active">
                            <i class="fas fa-male"></i> Male Voice
                        </button>
                        <button id="femaleBtn" class="gender-btn">
                            <i class="fas fa-female"></i> Female Voice
                        </button>
                        <button id="neutralBtn" class="gender-btn">
                            <i class="fas fa-user"></i> Neutral
                        </button>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <label for="rate"><i class="fas fa-tachometer-alt"></i> Speech Rate: <span id="rateValue">1.0</span></label>
                        <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1.0">
                    </div>
                    
                    <div class="control-group">
                        <label for="pitch"><i class="fas fa-sliders-h"></i> Pitch: <span id="pitchValue">1.0</span></label>
                        <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1.0">
                    </div>
                    
                    <div class="control-group">
                        <label for="volume"><i class="fas fa-volume-up"></i> Volume: <span id="volumeValue">1.0</span></label>
                        <input type="range" id="volume" min="0" max="1" step="0.1" value="1.0">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="speakBtn" class="btn btn-primary">
                        <i class="fas fa-play"></i> Speak
                    </button>
                    <button id="translateSpeakBtn" class="btn btn-secondary">
                        <i class="fas fa-language"></i> Translate & Speak
                    </button>
                    <button id="generateMp3Btn" class="btn btn-success">
                        <i class="fas fa-file-audio"></i> Generate MP3
                    </button>
                    <button id="recordAudioBtn" class="btn btn-warning">
                        <i class="fas fa-microphone"></i> Record Audio
                    </button>
                </div>
                
                <div class="action-buttons">
                    <button id="pauseBtn" class="btn btn-secondary">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button id="stopBtn" class="btn btn-danger">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button id="downloadMp3Btn" class="btn btn-success">
                        <i class="fas fa-download"></i> Download MP3
                    </button>
                    <button id="downloadWavBtn" class="btn btn-secondary">
                        <i class="fas fa-download"></i> Download WAV
                    </button>
                </div>
                
                <div class="download-progress" id="downloadProgress">
                    <div id="progressText">Generating MP3 file... 0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
                
                <div class="audio-visualizer">
                    <h2><i class="fas fa-wave-square"></i> Audio Visualizer</h2>
                    <canvas id="waveCanvas"></canvas>
                    
                    <div class="audio-controls">
                        <div class="audio-info">
                            <span id="audioStatus">Ready to speak</span>
                        </div>
                        <div class="audio-info">
                            <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="audio-analysis">
                    <h2><i class="fas fa-chart-bar"></i> Audio Analysis</h2>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div class="value" id="wordCount">0</div>
                            <div class="label">Word Count</div>
                        </div>
                        <div class="analysis-item">
                            <div class="value" id="charCount">0</div>
                            <div class="label">Character Count</div>
                        </div>
                        <div class="analysis-item">
                            <div class="value" id="speechDuration">0s</div>
                            <div class="label">Estimated Duration</div>
                        </div>
                        <div class="analysis-item">
                            <div class="value" id="language">EN</div>
                            <div class="label">Current Language</div>
                        </div>
                    </div>
                </div>
                
                <div class="audio-analysis" style="margin-top: 30px;">
                    <h2><i class="fas fa-sliders-h"></i> Voice & Audio Settings</h2>
                    <div class="controls">
                        <div class="control-group">
                            <label for="voiceSelect"><i class="fas fa-microphone"></i> Voice Type</label>
                            <select id="voiceSelect">
                                <option value="standard">Standard Voice</option>
                                <option value="news">News Reader</option>
                                <option value="storyteller">Storyteller</option>
                                <option value="soft">Soft Voice</option>
                                <option value="powerful">Powerful Voice</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="accentSelect"><i class="fas fa-globe-americas"></i> Accent</label>
                            <select id="accentSelect">
                                <option value="native">Native</option>
                                <option value="american">American</option>
                                <option value="british">British</option>
                                <option value="australian">Australian</option>
                                <option value="indian">Indian</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="audioFormat"><i class="fas fa-file-audio"></i> Export Format</label>
                            <select id="audioFormat">
                                <option value="mp3">MP3 (Recommended)</option>
                                <option value="wav">WAV (High Quality)</option>
                                <option value="ogg">OGG (Compressed)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button id="saveBtn" class="btn btn-secondary">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        <button id="clearBtn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Clear Text
                        </button>
                        <button id="audioTestBtn" class="btn btn-secondary">
                            <i class="fas fa-volume-up"></i> Test Audio
                        </button>
                    </div>
                </div>
                
                <div class="audio-library">
                    <h2><i class="fas fa-folder-open"></i> Audio Library</h2>
                    <div class="audio-files" id="audioLibrary">
                        <!-- Audio files will be added here -->
                        <div class="audio-file">
                            <div class="audio-file-header">
                                <div class="audio-file-title">Welcome Message</div>
                                <div class="audio-file-info">English | Male</div>
                            </div>
                            <div class="audio-file-actions">
                                <button class="btn btn-small btn-secondary play-audio">
                                    <i class="fas fa-play"></i> Play
                                </button>
                                <button class="btn btn-small btn-success download-audio" data-format="mp3">
                                    <i class="fas fa-download"></i> MP3
                                </button>
                                <button class="btn btn-small btn-secondary download-audio" data-format="wav">
                                    <i class="fas fa-download"></i> WAV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="history-section">
                    <h2><i class="fas fa-history"></i> Recent Conversions</h2>
                    <div id="historyList">
                        <!-- History items will be added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Advanced Text-to-Speech Tool with Multi-Language Translation & Audio Export | Built with Web Speech API</p>
            <p>Note: Full MP3 generation requires backend API. This demo simulates the functionality.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const textInput = document.getElementById('textInput');
        const sourceLang = document.getElementById('sourceLang');
        const targetLang = document.getElementById('targetLang');
        const maleBtn = document.getElementById('maleBtn');
        const femaleBtn = document.getElementById('femaleBtn');
        const neutralBtn = document.getElementById('neutralBtn');
        const rateSlider = document.getElementById('rate');
        const pitchSlider = document.getElementById('pitch');
        const volumeSlider = document.getElementById('volume');
        const rateValue = document.getElementById('rateValue');
        const pitchValue = document.getElementById('pitchValue');
        const volumeValue = document.getElementById('volumeValue');
        const speakBtn = document.getElementById('speakBtn');
        const translateSpeakBtn = document.getElementById('translateSpeakBtn');
        const generateMp3Btn = document.getElementById('generateMp3Btn');
        const recordAudioBtn = document.getElementById('recordAudioBtn');
        const downloadMp3Btn = document.getElementById('downloadMp3Btn');
        const downloadWavBtn = document.getElementById('downloadWavBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');
        const audioTestBtn = document.getElementById('audioTestBtn');
        const waveCanvas = document.getElementById('waveCanvas');
        const audioStatus = document.getElementById('audioStatus');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');
        const wordCount = document.getElementById('wordCount');
        const charCount = document.getElementById('charCount');
        const speechDuration = document.getElementById('speechDuration');
        const languageDisplay = document.getElementById('language');
        const historyList = document.getElementById('historyList');
        const audioLibrary = document.getElementById('audioLibrary');
        const downloadProgress = document.getElementById('downloadProgress');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        
        // Audio context for visualization
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let analyser, source, dataArray, bufferLength;
        const canvasCtx = waveCanvas.getContext('2d');
        
        // Speech synthesis
        let speech = new SpeechSynthesisUtterance();
        let voices = [];
        let isSpeaking = false;
        let isPaused = false;
        let startTime = 0;
        let timerInterval = null;
        let currentGender = 'male';
        let history = [];
        let audioFiles = [];
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        
        // Initialize the app
        function init() {
            // Update slider value displays
            rateSlider.addEventListener('input', () => rateValue.textContent = rateSlider.value);
            pitchSlider.addEventListener('input', () => pitchValue.textContent = pitchSlider.value);
            volumeSlider.addEventListener('input', () => volumeValue.textContent = volumeSlider.value);
            
            // Voice gender selection
            maleBtn.addEventListener('click', () => setGender('male'));
            femaleBtn.addEventListener('click', () => setGender('female'));
            neutralBtn.addEventListener('click', () => setGender('neutral'));
            
            // Button events
            speakBtn.addEventListener('click', speakText);
            translateSpeakBtn.addEventListener('click', translateAndSpeak);
            generateMp3Btn.addEventListener('click', generateMp3);
            recordAudioBtn.addEventListener('click', toggleRecording);
            downloadMp3Btn.addEventListener('click', downloadLastAudio);
            downloadWavBtn.addEventListener('click', downloadLastAudioAsWav);
            pauseBtn.addEventListener('click', togglePause);
            stopBtn.addEventListener('click', stopSpeech);
            saveBtn.addEventListener('click', saveSettings);
            clearBtn.addEventListener('click', clearText);
            audioTestBtn.addEventListener('click', testAudio);
            
            // Text input analysis
            textInput.addEventListener('input', updateAnalysis);
            
            // Initialize speech synthesis
            window.speechSynthesis.onvoiceschanged = () => {
                voices = window.speechSynthesis.getVoices();
            };
            
            // Initialize audio visualization
            initAudioVisualizer();
            
            // Update analysis on load
            updateAnalysis();
            
            // Load settings and history from localStorage
            loadSettings();
            loadHistory();
            loadAudioLibrary();
            
            // Set up event delegation for audio library buttons
            audioLibrary.addEventListener('click', handleAudioLibraryClick);
        }
        
        // Set voice gender
        function setGender(gender) {
            currentGender = gender;
            
            // Update button states
            maleBtn.classList.remove('active');
            femaleBtn.classList.remove('active');
            neutralBtn.classList.remove('active');
            
            if (gender === 'male') maleBtn.classList.add('active');
            else if (gender === 'female') femaleBtn.classList.add('active');
            else neutralBtn.classList.add('active');
            
            // Update language display
            languageDisplay.textContent = sourceLang.value.toUpperCase();
        }
        
        // Update text analysis
        function updateAnalysis() {
            const text = textInput.value;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            const characters = text.length;
            
            wordCount.textContent = words.length;
            charCount.textContent = characters;
            
            // Estimate speech duration (assuming average 150 words per minute)
            const duration = Math.round(words.length / 150 * 60);
            speechDuration.textContent = `${duration}s`;
        }
        
        // Initialize audio visualizer
        function initAudioVisualizer() {
            waveCanvas.width = waveCanvas.offsetWidth;
            waveCanvas.height = waveCanvas.offsetHeight;
            
            // Draw static wave
            drawStaticWave();
        }
        
        // Draw static wave
        function drawStaticWave() {
            canvasCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
            
            canvasCtx.strokeStyle = '#4cc9f0';
            canvasCtx.lineWidth = 2;
            canvasCtx.beginPath();
            
            const centerY = waveCanvas.height / 2;
            const amplitude = waveCanvas.height / 4;
            
            for (let x = 0; x < waveCanvas.width; x++) {
                const y = centerY + Math.sin(x * 0.05) * amplitude * Math.random() * 0.3;
                
                if (x === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
            }
            
            canvasCtx.stroke();
        }
        
        // Start visualization
        function startVisualization() {
            // In a real implementation, this would connect to the actual audio
            // For this demo, we'll simulate visualization
            drawAnimatedWave();
        }
        
        // Draw animated wave
        function drawAnimatedWave() {
            if (!isSpeaking && !isPaused && !isRecording) {
                drawStaticWave();
                return;
            }
            
            canvasCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
            
            canvasCtx.strokeStyle = '#4cc9f0';
            canvasCtx.lineWidth = 2;
            canvasCtx.beginPath();
            
            const centerY = waveCanvas.height / 2;
            const amplitude = waveCanvas.height / 3;
            const time = Date.now() / 1000;
            
            for (let x = 0; x < waveCanvas.width; x++) {
                const y = centerY + Math.sin(x * 0.05 + time * 3) * amplitude * 
                          (isPaused ? 0.2 : 1) * 
                          (isRecording ? 1.5 : 1) *
                          (1 - Math.abs(x - waveCanvas.width/2) / (waveCanvas.width/2)) * 0.7;
                
                if (x === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
            }
            
            canvasCtx.stroke();
            
            // Add frequency bars for visual effect
            const barCount = 30;
            const barWidth = waveCanvas.width / barCount;
            
            for (let i = 0; i < barCount; i++) {
                const x = i * barWidth + barWidth / 2;
                const barHeight = Math.sin(time * 4 + i * 0.5) * amplitude * 0.3 + 
                                 Math.sin(time * 2 + i * 0.3) * amplitude * 0.2;
                
                canvasCtx.fillStyle = isRecording ? 'rgba(243, 156, 18, 0.7)' : 'rgba(76, 201, 240, 0.5)';
                canvasCtx.fillRect(x - barWidth/4, centerY - barHeight/2, barWidth/2, barHeight);
            }
            
            requestAnimationFrame(drawAnimatedWave);
        }
        
        // Speak the text
        function speakText() {
            if (isSpeaking && !isPaused) {
                window.speechSynthesis.pause();
                isPaused = true;
                audioStatus.textContent = "Paused";
                return;
            }
            
            if (isPaused) {
                window.speechSynthesis.resume();
                isPaused = false;
                audioStatus.textContent = "Speaking...";
                return;
            }
            
            const text = textInput.value.trim();
            if (!text) {
                alert("Please enter some text to speak.");
                return;
            }
            
            // Configure speech
            speech.text = text;
            speech.lang = sourceLang.value + "-" + sourceLang.value.toUpperCase();
            speech.rate = parseFloat(rateSlider.value);
            speech.pitch = parseFloat(pitchSlider.value);
            speech.volume = parseFloat(volumeSlider.value);
            
            // Set voice based on gender preference
            setVoiceByGender();
            
            // Start speech
            window.speechSynthesis.speak(speech);
            
            // Update UI state
            isSpeaking = true;
            isPaused = false;
            audioStatus.textContent = "Speaking...";
            
            // Start timer
            startTimer();
            
            // Start visualization
            startVisualization();
            
            // Add to history
            addToHistory(text, sourceLang.value, currentGender);
            
            // Speech event handlers
            speech.onend = function() {
                isSpeaking = false;
                isPaused = false;
                audioStatus.textContent = "Finished";
                clearInterval(timerInterval);
                currentTime.textContent = "00:00";
            };
            
            speech.onerror = function(event) {
                console.error("Speech synthesis error:", event);
                isSpeaking = false;
                isPaused = false;
                audioStatus.textContent = "Error occurred";
                clearInterval(timerInterval);
            };
        }
        
        // Set voice by gender
        function setVoiceByGender() {
            if (!voices.length) {
                voices = window.speechSynthesis.getVoices();
            }
            
            // Filter voices by language and gender preference
            const langCode = sourceLang.value;
            let filteredVoices = voices.filter(voice => 
                voice.lang.startsWith(langCode)
            );
            
            // If no voices for selected language, use any voice
            if (filteredVoices.length === 0) {
                filteredVoices = voices;
            }
            
            // Try to find a voice matching the gender preference
            let selectedVoice = filteredVoices[0];
            
            if (currentGender === 'male') {
                // Look for male-sounding voices (often indicated in voice name)
                const maleVoices = filteredVoices.filter(voice => 
                    voice.name.toLowerCase().includes('male') || 
                    voice.name.toLowerCase().includes('man') ||
                    voice.name.includes('Microsoft David') ||
                    voice.name.includes('Google UK English Male')
                );
                
                if (maleVoices.length > 0) {
                    selectedVoice = maleVoices[0];
                }
            } else if (currentGender === 'female') {
                // Look for female-sounding voices
                const femaleVoices = filteredVoices.filter(voice => 
                    voice.name.toLowerCase().includes('female') || 
                    voice.name.toLowerCase().includes('woman') ||
                    voice.name.toLowerCase().includes('female') ||
                    voice.name.includes('Microsoft Zira') ||
                    voice.name.includes('Google UK English Female')
                );
                
                if (femaleVoices.length > 0) {
                    selectedVoice = femaleVoices[0];
                }
            }
            
            speech.voice = selectedVoice;
        }
        
        // Translate and speak (simulated - in real implementation would use translation API)
        function translateAndSpeak() {
            const text = textInput.value.trim();
            if (!text) {
                alert("Please enter some text to translate and speak.");
                return;
            }
            
            // In a real implementation, this would call a translation API
            // For this demo, we'll simulate translation
            const source = sourceLang.value;
            const target = targetLang.value;
            
            if (source === target) {
                alert("Source and target languages are the same. Please select different languages for translation.");
                return;
            }
            
            // Simulate translation with a mock message
            const translatedText = `[Translated to ${targetLang.options[targetLang.selectedIndex].text}: ${text.substring(0, 50)}...]`;
            
            // Show translation in a temporary alert (in real app would display in UI)
            alert(`Translation simulation:\n\nOriginal (${source}): ${text.substring(0, 100)}...\n\nTranslated (${target}): ${translatedText}\n\nNote: This is a frontend demo. Real translation requires API integration.`);
            
            // Speak the original text with target language
            const originalLang = sourceLang.value;
            sourceLang.value = target;
            
            // Update language display
